{% extends 'pwaMessenger/main.html' %}
{% block title %}{{page_title}}{% endblock title %}
{% block main %}
<div class="row m-0 scroll">
    <textarea id="chat-log" cols="100" rows="20"></textarea><br/>


    <!--    <div class="col-12">-->
    <!--        <div class="row">-->
    <!--            <div class="col-12 question justify-content-start mt-3">-->
    <!--                <div class="row">-->
    <!--                    <div class="col-8">-->
    <!--                        <div class="bubble bubble-question">-->
    <!--                            <span>Привет!</span>-->
    <!--                        </div>-->
    <!--                    </div>-->
    <!--                </div>-->
    <!--            </div>-->
    <!--        </div>-->
    <!--        <div class="row">-->
    <!--            <div class="col-12 answer justify-content-end mt-3">-->
    <!--                <div class="row justify-content-end">-->
    <!--                    <div class="col-8 d-flex justify-content-end">-->
    <!--                        <div class="bubble bubble-answer">-->
    <!--                            <span>Привет!</span>-->
    <!--                        </div>-->
    <!--                    </div>-->
    <!--                </div>-->
    <!--            </div>-->
    <!--        </div>-->
    <!--    </div>-->
    <div class="row">
        <div class="col">
            <input type="text" class="form-control form-login" id="chat-message-input">
            <button type="button" class="btn btn-main" id="chat-message-submit">Send</button>
        </div>
    </div>
</div>
{% endblock main %}
{% block scripts %}
<script>
    let roomName = {{room_name_json}};
    let cur_user = {{current_user}};
    let user_name = {{username}};

    let chatSocket = new WebSocket(
        'ws://' + window.location.host +
        '/ws/chat/' + roomName + '/');


    // console.log(username);
    // chatSocket.onconnect = function (e) {
    //     // chatSocket.send(JSON.stringify({
    //     //     'still_online': 'Yes',
    //     // }));
    // };


    chatSocket.onmessage = function (e) {
        let data = JSON.parse(e.data);
        let message = data['message'];
        document.querySelector('#chat-log').value += (user_name + '--->' + message + '\n')
    };

    chatSocket.onclose = function (e) {
        console.error('Chat socket closed unexpectedly');
    };

    document.querySelector('#chat-message-input').focus();
    document.querySelector('#chat-message-input').onkeyup = function (e) {
        if (e.keyCode === 13) {  // enter, return
            document.querySelector('#chat-message-submit').click();
        }
    };

    document.querySelector('#chat-message-submit').onclick = function (e) {
        let messageInputDom = document.querySelector('#chat-message-input');
        let message = messageInputDom.value;
        chatSocket.send(JSON.stringify({
            'message': message,
            // 'still_online': 'Yes',
        }));

        messageInputDom.value = '';
    };
</script>
<script>
    $('.scroll').scrollTop($('body').height());
</script>
{% endblock scripts %}