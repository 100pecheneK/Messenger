{% extends 'pwaMessenger/main.html' %}
{% block title %}{{page_title}}{% endblock title %}
{% block main %}
<div class="row h-100">
    <div class="col-12 m-0 dialog" id="dialog">
        <div class="col-12" id="messagesWindows">
            {% for msg in messages %}
            {% if msg.author != request.user %}
            <div class="row">
                <div class="col-12 question justify-content-start mt-3">
                    <div class="row">
                        <div class="col-8">
                            <div class="bubble bubble-question">
                                <span>{{msg.content}}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="row">
                <div class="col-12 answer justify-content-end mt-3">
                    <div class="row justify-content-end">
                        <div class="col-8 d-flex justify-content-end">
                            <div class="bubble bubble-answer">
                                <span>{{msg.content}}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>
    <div class="col-10 pr-0">
        <input type="text" class="form-control form-login input-msg rounded-0" id="chat-message-input">
    </div>
    <div class="col-2 pl-0">
        <button type="button" class="btn btn-main send-msg rounded-0" id="chat-message-submit"><i
                class="fa fa-arrow-alt-circle-up"></i></button>
    </div>
</div>


{% endblock main %}
{% block scripts %}
<script>
    function scrollDialog() {
        // Прокркутить dialog до низу
        var div = $("#dialog");
        div.scrollTop(div.prop('scrollHeight'));

    }
    function createDivMessageAnswer(content) {

        var div = document.createElement('div');
        div.className = "row";
        div.innerHTML = '<div class="col-12 answer justify-content-end mt-3"><div class="row justify-content-end"><div class="col-8 d-flex justify-content-end"><div class="bubble bubble-answer"><span>' + content + '</span></div></div></div></div>';
        return div;
    }
    function createDivMessageQuestion(content) {
        var div = document.createElement('div');
        div.className = "row";
        div.innerHTML = '<div class="col-12 question justify-content-start mt-3"><div class="row"><div class="col-8"><div class="bubble bubble-question"><span>' + content + '</span></div></div></div></div>';
        return div;
    }

</script>
<script>
    scrollDialog();
    let roomName = {{ room_name_json }};
    let cur_user = {{ current_user }};
    let current_room_name = {{ current_room_name }};

    // let messages = {{ messages }}
    //создаем сокет
    let chatSocket = new WebSocket(
        'ws://' + window.location.host +
        '/ws/chat/' + roomName + '/');



    // обработка сообщений с бэкенда
    chatSocket.onmessage = function (e) {
        let data = JSON.parse(e.data);

        // let still_online = data['still_online'];
        if (data['message']) {
            var message = data['message'];
            var author = data['author'];

            if (author == cur_user) {
                var msg = createDivMessageAnswer(message);
            } else {
                var msg = createDivMessageQuestion(message);
            }
            let main = $('#messagesWindows');
            main.append(msg);
            scrollDialog()

        }
    };

    //выхлоп
    chatSocket.onclose = function (e) {
        console.error('Chat socket closed unexpectedly');
    };

    // document.querySelector('#chat-message-input').focus();
    // document.querySelector('#chat-message-input').onkeyup = function (e) {
    //     if (e.keyCode === 13) {  // enter, return
    //         document.querySelector('#chat-message-submit').click();
    //     }
    // };

    //отправляем на бэкенд сообщение пользователя
    document.querySelector('#chat-message-submit').onclick = function (e) {
        let messageInputDom = document.querySelector('#chat-message-input');
        let message = messageInputDom.value;
        chatSocket.send(JSON.stringify({
            'message': message,
            'author': cur_user,
            'current_room_name': current_room_name,
        }));

        messageInputDom.value = '';


    };

    function delay() {
        return new Promise(resolve => setTimeout(resolve, 5000));
    }
    //Держим сокет открытым
    async function get_page_alive() {
        while (true) {
            await delay();
            await console.log('PAGE_is_ALIVE');
        }
    }

    get_page_alive();
</script>
{% endblock scripts %}